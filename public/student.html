<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×××©×§ ×ª×œ××™×“ - ×ª×¨×’×™×œ ×¡×™×¢×•×¨ ××•×—×•×ª</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .student-name {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .timer {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .task-description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 4px solid #667eea;
        }

        .input-area {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .name-count {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .waiting-screen, .blocked-screen {
            text-align: center;
        }

        .waiting-screen h2, .blocked-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .status-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .blocked-screen {
            background: #fff3cd;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #ffc107;
        }

        .group-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .timer {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Content will be dynamically inserted here -->
    </div>

    <script>
        // âœ… CRITICAL FIX: Use dynamic URL for production
        const API_URL = window.location.origin;
        const socket = io(API_URL);

        let currentStudent = null;
        let students = [];
        let activeSession = null;
        let currentGroup = null;
        let timerInterval = null;
        let remainingTime = 0;
        let submittedNames = [];

        // Initialize
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('initialState', (state) => {
            console.log('Received initialState:', state);
            students = state.students || [];
            const sessions = state.activeSessions || [];
            activeSession = sessions.find(s => !s.completed) || null;

            // Check if student is registered
            const storedId = localStorage.getItem('studentId');
            const storedName = localStorage.getItem('studentName');

            if (!storedId || !storedName) {
                window.location.href = 'register.html';
                return;
            }

            currentStudent = students.find(s => s.id === parseInt(storedId));

            if (!currentStudent) {
                localStorage.removeItem('studentId');
                localStorage.removeItem('studentName');
                window.location.href = 'register.html';
                return;
            }

            if (activeSession) {
                findCurrentGroup();
                checkSubmissionPermission();
            } else {
                showWaitingScreen();
            }
        });

        socket.on('sessionStarted', (session) => {
            console.log('Session started:', session);
            activeSession = session;
            findCurrentGroup();
            checkSubmissionPermission();
        });

        socket.on('sessionEnded', () => {
            console.log('Session ended');
            activeSession = null;
            currentGroup = null;
            showWaitingScreen();
        });

        socket.on('timeUpdate', (data) => {
            remainingTime = data.remainingTime;
            updateTimerDisplay();
        });

        socket.on('submissionReceived', (data) => {
            if (data.studentId === currentStudent.id) {
                showSuccessMessage();
            }
        });

        function findCurrentGroup() {
            if (!activeSession || !currentStudent) return;

            for (const group of activeSession.groups) {
                if (group.members.includes(currentStudent.id)) {
                    currentGroup = group;
                    submittedNames = group.submissions
                        .filter(s => s.studentId === currentStudent.id)
                        .flatMap(s => s.names);
                    break;
                }
            }
        }

        function checkSubmissionPermission() {
            if (!currentGroup) {
                showWaitingScreen();
                return;
            }

            if (currentGroup.type === 'regular') {
                const hasOtherSubmission = currentGroup.submissions.some(
                    s => s.studentId !== currentStudent.id
                );

                if (hasOtherSubmission) {
                    showBlockedScreen();
                } else {
                    showExerciseScreen();
                }
            } else {
                showExerciseScreen();
            }
        }

        function showWaitingScreen() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="waiting-screen">
                    <div class="status-icon">â³</div>
                    <h2>×××ª×™×Ÿ ×œ×”×ª×—×œ×ª ×”×ª×¨×’×™×œ</h2>
                    <p>×”××¨×¦×” ×˜×¨× ×”×ª×—×™×œ ××ª ×”××©×™××”. ×× × ×”××ª×Ÿ...</p>
                </div>
            `;
        }

        function showBlockedScreen() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="blocked-screen">
                    <div class="status-icon">ğŸ”’</div>
                    <h2>×—×‘×¨ ×§×‘×•×¦×” ××—×¨ ×›×‘×¨ ×¢×•×‘×“</h2>
                    <p>×‘×§×‘×•×¦×” ×¨×’×™×œ×”, ×¨×§ ×—×‘×¨ ××—×“ ×™×›×•×œ ×œ××œ× ××ª ×”××©×™××” ×‘×›×œ ×¤×¢×.</p>
                    <p>×× × ×”××ª×Ÿ ×¢×“ ×©×”×—×‘×¨ ×”×©× ×™ ×™×¡×™×™×.</p>
                </div>
            `;
        }

        function showExerciseScreen() {
            remainingTime = activeSession.duration;
            
            document.getElementById('mainContainer').innerHTML = `
                <h1>ğŸ’¡ ××©×™××ª ×¡×™×¢×•×¨ ××•×—×•×ª</h1>
                <div class="student-name">×©×œ×•×, ${currentStudent.name}!</div>
                
                <div class="group-info">
                    <strong>×§×‘×•×¦×” ${currentGroup.type === 'nominal' ? '× ×•××™× ×œ×™×ª' : '×¨×’×™×œ×”'}</strong>
                </div>

                <div class="timer" id="timer">
                    ${formatTime(remainingTime)}
                </div>

                <div class="task-description">
                    <h3>×”××©×™××” ×©×œ×š:</h3>
                    <p>×¨×©×•× ×©××•×ª ×©×œ ×× ×©×™× ××¤×•×¨×¡××™× ×‘×™×©×¨××œ (×¤×•×œ×™×˜×™×§××™×, ××× ×™×, ×¡×¤×•×¨×˜××™× ×•×›×•')</p>
                    <p><strong>×—×©×•×‘:</strong> ×¨×©×•× ×›×œ ×©× ×‘×©×•×¨×” × ×¤×¨×“×ª</p>
                </div>

                <div class="input-area">
                    <div class="name-count" id="nameCount">×©××•×ª ×©×”×•×¡×¤×ª: ${submittedNames.length}</div>
                    <textarea 
                        id="namesInput" 
                        placeholder="×“×•×’××”:
×“×•×“ ×‘×Ÿ ×’×•×¨×™×•×Ÿ
×’×•×œ×“×” ×××™×¨
×™×¦×—×§ ×¨×‘×™×Ÿ"
                    >${submittedNames.join('\n')}</textarea>
                </div>

                <button onclick="submitNames()" id="submitBtn">
                    ×©×œ×— ×ª×©×•×‘×•×ª
                </button>

                <div id="successMessage" style="display: none;"></div>
            `;

            startTimer();

            document.getElementById('namesInput').addEventListener('input', updateNameCount);
        }

        function updateNameCount() {
            const text = document.getElementById('namesInput').value;
            const names = text.split('\n').filter(name => name.trim().length > 0);
            document.getElementById('nameCount').textContent = `×©××•×ª ×©×”×•×¡×¤×ª: ${names.length}`;
        }

        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    alert('×”×–××Ÿ × ×’××¨! ×”××©×™××” ×”×¡×ª×™×™××”.');
                    showWaitingScreen();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = formatTime(remainingTime);
                
                if (remainingTime <= 60) {
                    timerElement.style.background = 'linear-gradient(135deg, #f5576c 0%, #c71d3b 100%)';
                }
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function submitNames() {
            const text = document.getElementById('namesInput').value;
            const names = text.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);

            if (names.length === 0) {
                alert('×× × ×”×›× ×¡ ×œ×¤×—×•×ª ×©× ××—×“');
                return;
            }

            socket.emit('submitAnswer', {
                sessionId: activeSession.id,
                groupId: currentGroup.id,
                studentId: currentStudent.id,
                names: names
            });

            submittedNames = names;
        }

        function showSuccessMessage() {
            const msgDiv = document.getElementById('successMessage');
            if (msgDiv) {
                msgDiv.className = 'success-message';
                msgDiv.style.display = 'block';
                msgDiv.innerHTML = 'âœ… ×”×ª×©×•×‘×•×ª × ×©×œ×—×• ×‘×”×¦×œ×—×”!';

                setTimeout(() => {
                    msgDiv.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממשק מרצה - תרגיל סיעור מוחות</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-indigo-900">ממשק מרצה - תרגיל סיעור מוחות</h1>
        </div>

        <div id="setupView" class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">תלמידים רשומים</h2>
                    <div class="flex gap-2">
                        <button onclick="addDemoStudents()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 text-sm">
                            🧪 הוסף 20 תלמידים לדוגמה
                        </button>
                        <a href="register.html" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                            🔗 פתח דף רישום
                        </a>
                    </div>
                </div>
                <div id="studentsList" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>
                <div class="text-gray-600">סך הכל: <span id="studentCount">0</span> תלמידים</div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">יצירת קבוצות</h2>
                
                <!-- Group Creation Form -->
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-3">צור קבוצה חדשה</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block mb-2 font-semibold">סוג קבוצה:</label>
                            <select id="groupType" class="w-full p-2 border-2 rounded-lg">
                                <option value="regular">👥 קבוצה רגילה</option>
                                <option value="nominal">👤 קבוצה נומינלית</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block mb-2 font-semibold">מספר חברים:</label>
                            <input 
                                type="number" 
                                id="groupSize" 
                                min="4" 
                                value="4" 
                                class="w-full p-2 border-2 rounded-lg"
                                placeholder="לפחות 4"
                            />
                        </div>
                        
                        <div class="flex items-end">
                            <button 
                                onclick="createGroup()" 
                                class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold"
                            >
                                ➕ צור קבוצה
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 bg-white p-3 rounded">
                        <strong>💡 טיפ:</strong> תלמידים זמינים: <span id="availableCount" class="font-bold text-green-600">0</span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-3 mb-4">
                    <button onclick="createMultipleGroups('regular', 4)" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">
                        צור קבוצות רגילות (4 חברים)
                    </button>
                    <button onclick="createMultipleGroups('nominal', 4)" class="flex-1 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 text-sm">
                        צור קבוצות נומינליות (4 חברים)
                    </button>
                </div>
                
                <div id="groupsList" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">הפעלת קבוצות</h2>
                
                <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4 mb-4">
                    <div class="font-bold text-purple-900 mb-2">🧪 מצב בדיקה</div>
                    <button onclick="fillDemoAnswers()" class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 font-semibold mb-3">
                        מלא תשובות לדוגמה לכל הקבוצות
                    </button>
                    <button onclick="completeAllNow()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 font-semibold mb-3">
                        📊 בדוק תשובות והצג תוצאות
                    </button>
                    <p class="text-sm text-purple-700 mt-2">כלי בדיקה עבור המרצה</p>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">משך הזמן (דקות):</label>
                    <input type="number" id="durationInput" value="10" min="1" class="w-32 p-3 border rounded-lg"/>
                </div>
                
                <div class="space-y-3">
                    <button onclick="startAllGroups()" class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 text-lg font-bold">
                        🚀 התחל את כל הקבוצות יחד
                    </button>
                    
                    <div class="text-center text-gray-600 font-semibold">או</div>
                    
                    <div id="individualGroupButtons" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <div id="monitorView" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">ניטור קבוצות פעילות</h2>
                <div id="activeGroupsMonitor" class="space-y-4"></div>
                
                <button onclick="completeAll()" class="w-full mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-bold">
                    📊 סיים והצג תוצאות כוללות
                </button>
            </div>
        </div>

        <div id="resultsView" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">📊 תוצאות התרגיל</h2>
                
                <div id="summarySection" class="mb-8"></div>
                
                <div class="mb-8">
                    <canvas id="resultsChart" class="max-w-3xl mx-auto"></canvas>
                </div>
                
                <h3 class="text-2xl font-bold mb-4">תוצאות מפורטות לפי קבוצה</h3>
                <div id="resultsContainer" class="space-y-6"></div>
                
                <button onclick="resetToSetup()" class="w-full mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
                    התחל תרגיל חדש (שמור תלמידים וקבוצות)
                </button>
                
                <button onclick="fullReset()" class="w-full mt-3 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
                    🗑️ איפוס מלא (מחק הכל)
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const socket = io(API_URL);

        let students = [];
        let groups = [];
        let activeSessions = [];
        let timerIntervals = {};

        socket.on('initialState', (state) => {
            console.log('Received initialState:', state);
            students = state.students || [];
            groups = state.groups || [];
            activeSessions = state.activeSessions || [];
            renderStudents();
            renderGroups();
            renderIndividualGroupButtons();
            updateAvailableCount();
            if (activeSessions.some(s => !s.completed)) {
                showMonitorView();
            }
        });

        socket.on('studentsUpdated', (updatedStudents) => {
            students = updatedStudents;
            renderStudents();
            updateAvailableCount();
        });

        socket.on('groupsUpdated', (updatedGroups) => {
            groups = updatedGroups;
            renderGroups();
            renderIndividualGroupButtons();
            updateAvailableCount();
        });

        socket.on('sessionStarted', (session) => {
            activeSessions.push(session);
            showMonitorView();
            startSessionTimer(session);
        });

        socket.on('sessionEnded', (data) => {
            const session = activeSessions.find(s => s.id === data.sessionId);
            if (session) {
                session.completed = true;
                stopSessionTimer(session.id);
                renderActiveGroups();
            }
        });

        socket.on('allResultsReady', (results) => {
            showResultsView();
            renderResults(results);
        });

        socket.on('systemReset', () => {
            location.reload();
        });

        socket.on('manualVerificationUpdated', async (data) => {
            await refreshResults();
        });

        function updateAvailableCount() {
            const assignedIds = groups.flatMap(g => g.members.map(m => m.id));
            const available = students.filter(s => !assignedIds.includes(s.id));
            document.getElementById('availableCount').textContent = available.length;
        }

        async function addDemoStudents() {
            const demoNames = [
                'אבי כהן', 'בני לוי', 'גלי מזרחי', 'דני אברהם',
                'הדר יוסף', 'ונוס הוד', 'זוהר משה', 'חני שרה',
                'טלי יעקב', 'יעל רחל', 'כרמל אהרון', 'לירון מריה',
                'מיכל שמעון', 'נועה לאה', 'סתיו ראובן', 'עדי שמחה',
                'פנינה גד', 'צביה אשר', 'קרן נפתלי', 'רונית דן'
            ];

            if (students.length > 0) {
                if (!confirm('יש כבר תלמידים רשומים. להוסיף עוד 20 תלמידים לדוגמה?')) {
                    return;
                }
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'מוסיף תלמידים...';

            for (const name of demoNames) {
                try {
                    await fetch(`${API_URL}/api/students/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, skipDuplicateCheck: true })
                    });
                    await new Promise(resolve => setTimeout(resolve, 50));
                } catch (error) {
                    console.error(`Error adding ${name}:`, error);
                }
            }

            btn.disabled = false;
            btn.textContent = '🧪 הוסף 20 תלמידים לדוגמה';
            alert('20 תלמידים נוספו בהצלחה!');
        }

        async function createGroup(customSize = null) {
            const type = document.getElementById('groupType').value;
            const size = customSize || parseInt(document.getElementById('groupSize').value);

            if (size < 4) {
                alert('קבוצה חייבת להכיל לפחות 4 חברים');
                return;
            }

            const assignedIds = groups.flatMap(g => g.members.map(m => m.id));
            const availableStudents = students.filter(s => !assignedIds.includes(s.id));

            if (availableStudents.length < size) {
                alert(`אין מספיק תלמידים זמינים! יש ${availableStudents.length} זמינים, צריך ${size}`);
                return;
            }

            const memberIds = availableStudents.slice(0, size).map(s => s.id);
            
            try {
                await fetch(`${API_URL}/api/groups`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, memberIds })
                });
            } catch (error) {
                alert('שגיאה ביצירת קבוצה');
                console.error(error);
            }
        }

        async function createMultipleGroups(type, size) {
            const assignedIds = groups.flatMap(g => g.members.map(m => m.id));
            const availableStudents = students.filter(s => !assignedIds.includes(s.id));
            
            if (availableStudents.length < size) {
                alert(`אין מספיק תלמידים זמינים! יש ${availableStudents.length} זמינים, צריך לפחות ${size}`);
                return;
            }

            const totalStudents = availableStudents.length;
            const baseGroups = Math.floor(totalStudents / size);
            const remainder = totalStudents % size;
            
            // Always distribute remainder across existing groups
            // No group should have fewer than 4 members
            const groupSizes = [];
            for (let i = 0; i < baseGroups; i++) {
                // First 'remainder' groups get +1 student
                groupSizes.push(i < remainder ? size + 1 : size);
            }

            // Build confirmation message
            const sizeCounts = groupSizes.reduce((acc, s) => {
                acc[s] = (acc[s] || 0) + 1;
                return acc;
            }, {});

            let message = `ליצור ${baseGroups} קבוצות ${type === 'regular' ? 'רגילות' : 'נומינליות'}?\n\n`;
            Object.entries(sizeCounts).sort((a, b) => b[0] - a[0]).forEach(([s, count]) => {
                message += `• ${count} קבוצות של ${s} חברים\n`;
            });
            message += `\n📊 סה"כ: כל ${totalStudents} התלמידים ישובצו`;

            if (!confirm(message)) {
                return;
            }

            // Temporarily change the type selector
            const originalType = document.getElementById('groupType').value;
            document.getElementById('groupType').value = type;

            // Create groups
            const createdGroups = [];
            for (let i = 0; i < groupSizes.length; i++) {
                try {
                    await createGroup(groupSizes[i]);
                    createdGroups.push(groupSizes[i]);
                    await new Promise(resolve => setTimeout(resolve, 150));
                } catch (error) {
                    console.error('Error creating group:', error);
                }
            }

            // Restore original type
            document.getElementById('groupType').value = originalType;

            // Summary
            const summary = createdGroups.reduce((acc, s) => {
                acc[s] = (acc[s] || 0) + 1;
                return acc;
            }, {});

            let summaryText = `✅ נוצרו ${createdGroups.length} קבוצות בהצלחה!\n\n`;
            Object.entries(summary).sort((a, b) => b[0] - a[0]).forEach(([s, count]) => {
                summaryText += `• ${count} קבוצות של ${s} חברים\n`;
            });
            const totalAssigned = createdGroups.reduce((sum, s) => sum + s, 0);
            summaryText += `\n📊 סה"כ: ${totalAssigned} תלמידים שובצו`;

            alert(summaryText);
        }

        async function deleteGroup(id) {
            if (confirm('למחוק קבוצה זו?')) {
                await fetch(`${API_URL}/api/groups/${id}`, { method: 'DELETE' });
            }
        }

        async function startAllGroups() {
            if (groups.length === 0) {
                alert('אין קבוצות להפעלה');
                return;
            }
            const duration = parseInt(document.getElementById('durationInput').value) * 60;
            await fetch(`${API_URL}/api/session/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration, groupIds: groups.map(g => g.id) })
            });
        }

        async function startGroup(groupId) {
            const duration = parseInt(document.getElementById('durationInput').value) * 60;
            await fetch(`${API_URL}/api/session/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration, groupIds: [groupId] })
            });
        }

        async function completeAll() {
            const loading = document.createElement('div');
            loading.id = 'loadingOverlay';
            loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loading.innerHTML =
                '<div class="bg-white rounded-xl p-8 text-center max-w-md">' +
                '<div class="text-4xl mb-4">⏳</div>' +
                '<div class="text-xl font-bold mb-2">בודק שמות מפורסמים...</div>' +
                '<div class="text-gray-600 mb-4">זה יכול לקחת 1-2 דקות</div>' +
                '<div class="text-sm text-gray-500">אנא המתן ואל תסגור את החלון</div>' +
                '<div class="mt-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div></div>' +
                '</div>';
            document.body.appendChild(loading);

            try {
                const response = await fetch(`${API_URL}/api/sessions/complete-all`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Server error');
                }
            } catch (error) {
                console.error('Error completing sessions:', error);
                const loadingEl = document.getElementById('loadingOverlay');
                if (loadingEl) loadingEl.remove();
                alert('שגיאה בסיום התרגיל. נסה שוב.');
            }
        }

        async function completeAllNow() {
            if (!confirm('האם אתה בטוח שברצונך לבדוק את כל התשובות ולהציג תוצאות?')) {
                return;
            }
            await completeAll();
        }

        async function fillDemoAnswers() {
            if (groups.length === 0) {
                alert('אין קבוצות! צור קבוצות קודם.');
                return;
            }

            if (!confirm('זה ימלא תשובות אוטומטיות לכל הקבוצות. להמשיך?')) {
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'ממלא תשובות...';

            const demoAnswersByPair = {
                'צנ': ['צבי נשרי', 'ציפי נבון'],
                'תד': ['תמר הוד', 'תום הוד'],
                'קכ': ['קארין כהן', 'קרן כץ'],
                'עג': ['עמוס גילן', 'עדי גינזבורג'],
                'יח': ['יהודה חיון', 'יעל חסון'],
                'לט': ['לירון טבת', 'לאה טל'],
                'מץ': ['משה צור', 'מיכל צפון'],
                'רס': ['רון סער', 'רונית סלע'],
                'סו': ['סיגל ויצמן', 'סמי ועקנין'],
                'טר': ['טל רז', 'טלי רביב']
            };

            for (const group of groups) {
                if (group.type === 'regular') {
                    const firstMember = group.members[0];
                    
                    const answers = {};
                    Object.keys(demoAnswersByPair).forEach(pair => {
                        const numNames = Math.random() > 0.5 ? 2 : 1;
                        answers[pair] = demoAnswersByPair[pair].slice(0, numNames);
                    });

                    try {
                        await fetch(`${API_URL}/api/submissions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                studentId: firstMember.id,
                                groupId: group.id,
                                answers: answers
                            })
                        });
                    } catch (error) {
                        console.error('Error submitting for regular group:', error);
                    }
                } else {
                    for (const member of group.members) {
                        const answers = {};
                        Object.keys(demoAnswersByPair).forEach(pair => {
                            const numNames = Math.floor(Math.random() * 3);
                            answers[pair] = demoAnswersByPair[pair].slice(0, numNames);
                        });

                        try {
                            await fetch(`${API_URL}/api/submissions`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    studentId: member.id,
                                    groupId: null,
                                    answers: answers
                                })
                            });
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (error) {
                            console.error(`Error submitting for ${member.name}:`, error);
                        }
                    }
                }
            }

            btn.disabled = false;
            btn.textContent = 'מלא תשובות לדוגמה לכל הקבוצות';
            alert('תשובות נוספו בהצלחה! עכשיו תוכל ללחוץ על "בדוק תשובות והצג תוצאות"');
        }

        function renderStudents() {
            const container = document.getElementById('studentsList');
            if (!container) return;
            
            container.innerHTML = students.map(s =>
                '<div class="bg-gray-100 p-3 rounded-lg text-center font-semibold">' + s.name + '</div>'
            ).join('');
            document.getElementById('studentCount').textContent = students.length;
        }

        function renderGroups() {
            const container = document.getElementById('groupsList');
            if (!container) return;
            
            if (groups.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">אין קבוצות עדיין. צור קבוצה חדשה למעלה.</div>';
                return;
            }

            container.innerHTML = groups.map(g =>
                '<div class="border-2 rounded-lg p-4 ' + (g.type === 'regular' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50') + '">' +
                '<div class="flex justify-between items-start mb-2">' +
                '<div>' +
                '<h3 class="font-bold text-lg">' + g.name + '</h3>' +
                '<span class="text-sm px-3 py-1 rounded-full font-semibold ' + (g.type === 'regular' ? 'bg-blue-200 text-blue-900' : 'bg-purple-200 text-purple-900') + '">' +
                (g.type === 'regular' ? '👥 קבוצה רגילה' : '👤 קבוצה נומינלית') + ' (' + g.members.length + ' חברים)' +
                '</span>' +
                '</div>' +
                '<button onclick="deleteGroup(' + g.id + ')" class="text-red-500 hover:text-red-700 text-xl">🗑️</button>' +
                '</div>' +
                '<div class="flex flex-wrap gap-2 mt-3">' +
                g.members.map(m =>
                    '<span class="bg-white px-3 py-1 rounded-full text-sm font-semibold border-2 ' +
                    (g.type === 'regular' ? 'border-blue-300' : 'border-purple-300') + '">' + m.name + '</span>'
                ).join('') +
                '</div>' +
                '</div>'
            ).join('');
        }

        function renderIndividualGroupButtons() {
            const container = document.getElementById('individualGroupButtons');
            if (!container) return;
            
            if (groups.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">אין קבוצות עדיין</div>';
                return;
            }
            container.innerHTML = '<div class="text-sm text-gray-600 font-semibold mb-2">הפעל קבוצה ספציפית:</div>' +
                groups.map(g =>
                    '<button onclick="startGroup(' + g.id + ')" class="w-full ' +
                    (g.type === 'regular' ? 'bg-blue-500' : 'bg-purple-500') +
                    ' text-white px-4 py-2 rounded-lg hover:opacity-80 text-sm">▶ ' + g.name + ' (' + g.members.length + ' חברים)</button>'
                ).join('');
        }

        function renderActiveGroups() {
            const container = document.getElementById('activeGroupsMonitor');
            if (!container) return;
            
            const active = activeSessions.filter(s => !s.completed);
            
            if (active.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">אין סשנים פעילים כרגע</div>';
                return;
            }
            
            container.innerHTML = active.map(session => {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((session.endTime - now) / 1000));
                
                return '<div class="border-2 border-indigo-300 rounded-lg p-4 bg-indigo-50">' +
                    '<div class="flex justify-between items-center mb-3">' +
                    '<h3 class="text-xl font-bold">סשן ' + session.id + '</h3>' +
                    '<div class="text-3xl font-bold text-indigo-900">' + formatTime(remaining) + '</div>' +
                    '</div>' +
                    '<div class="grid grid-cols-2 gap-2">' +
                    session.groups.map(g =>
                        '<div class="bg-white p-2 rounded border">' +
                        '<div class="font-semibold text-sm">' + g.name + '</div>' +
                        '<div class="text-xs text-gray-600">' + g.members.length + ' חברים</div>' +
                        '</div>'
                    ).join('') +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function startSessionTimer(session) {
            renderActiveGroups();
            timerIntervals[session.id] = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((session.endTime - now) / 1000));
                
                if (remaining === 0) {
                    stopSessionTimer(session.id);
                    endSession(session.id);
                } else {
                    renderActiveGroups();
                }
            }, 1000);
        }

        function stopSessionTimer(sessionId) {
            if (timerIntervals[sessionId]) {
                clearInterval(timerIntervals[sessionId]);
                delete timerIntervals[sessionId];
            }
        }

        async function endSession(sessionId) {
            await fetch(`${API_URL}/api/session/end/${sessionId}`, { method: 'POST' });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        }

        async function renderResults(data) {
            // (Same results rendering code as before - keeping it the same)
            // This part stays unchanged from your current instructor.html
        }

        function renderChart(summary) {
            // (Same chart rendering code)
        }

        function showMonitorView() {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('monitorView').classList.remove('hidden');
            document.getElementById('resultsView').classList.add('hidden');
            renderActiveGroups();
        }

        function showResultsView() {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('monitorView').classList.add('hidden');
            document.getElementById('resultsView').classList.remove('hidden');
            
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        function resetToSetup() {
            if (confirm('האם אתה בטוח? זה ימחק רק את התוצאות, אבל ישמור את התלמידים והקבוצות.')) {
                document.getElementById('setupView').classList.remove('hidden');
                document.getElementById('monitorView').classList.add('hidden');
                document.getElementById('resultsView').classList.add('hidden');
                activeSessions = [];
                Object.values(timerIntervals).forEach(interval => clearInterval(interval));
                timerIntervals = {};
            }
        }

        async function fullReset() {
            if (confirm('⚠️ זה ימחק הכל - תלמידים, קבוצות ותוצאות!\n\nהאם אתה בטוח?')) {
                await fetch(`${API_URL}/api/reset`, { method: 'POST' });
            }
        }

        async function verifyNameManually(name, isValid) {
            const action = isValid ? 'אישור' : 'דחייה';
            
            if (!confirm(`האם אתה בטוח שברצונך ${isValid ? 'לאשר' : 'לדחות'} את השם "${name}"?\n\n⚠️ ההחלטה תחול על כל הקבוצות!`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/verify-name-manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, isValid })
                });
                
                if (response.ok) {
                    await refreshResults();
                    alert(`✅ השם "${name}" ${isValid ? 'אושר' : 'נדחה'} בהצלחה!`);
                } else {
                    alert('❌ שגיאה בעדכון הסטטוס');
                }
            } catch (error) {
                console.error('Error updating verification:', error);
                alert('❌ שגיאה בעדכון הסטטוס');
            }
        }

        async function resetManualVerification(name) {
            if (!confirm(`האם אתה בטוח שברצונך לבטל את ההחלטה הידנית עבור "${name}"?\n\nהשם יחזור לבדיקה אוטומטית.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/verify-name-manual/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                if (response.ok) {
                    await refreshResults();
                    alert(`🔄 ההחלטה הידנית עבור "${name}" בוטלה`);
                } else {
                    alert('❌ שגיאה באיפוס האימות');
                }
            } catch (error) {
                console.error('Error resetting verification:', error);
                alert('❌ שגיאה באיפוס האימות');
            }
        }

        async function refreshResults() {
            const container = document.getElementById('resultsContainer');
            const summarySection = document.getElementById('summarySection');
            
            container.innerHTML = '<div class="text-center py-8"><div class="text-2xl">🔄 מעדכן תוצאות...</div><div class="text-gray-600 mt-2">מחשב מחדש את כל הסטטיסטיקות</div></div>';
            summarySection.innerHTML = '<div class="text-center py-8"><div class="text-2xl">🔄 מחשב מחדש...</div></div>';
            
            try {
                const resultsResponse = await fetch(`${API_URL}/api/results`);
                const results = await resultsResponse.json();
                renderResults(results);
            } catch (error) {
                console.error('Error refreshing results:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-600"><div class="text-2xl">❌ שגיאה בטעינת תוצאות</div></div>';
            }
        }

        // Note: renderResults() function continues with the full implementation
        // Including all the results display, charts, and manual verification UI
        // (Keep the existing renderResults code from your current instructor.html)
    </script>
</body>
</html>
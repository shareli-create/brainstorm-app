<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממשק מרצה</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-indigo-900">ממשק מרצה - תרגיל סיעור מוחות</h1>
        </div>

        <div id="setupView" class="space-y-6">
            <!-- Students Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">תלמידים רשומים</h2>
                    <div class="flex gap-2">
                        <button onclick="addDemoStudents()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 text-sm">
                            🧪 הוסף 20 תלמידים לדוגמה
                        </button>
                        <a href="register.html" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                            🔗 פתח דף רישום
                        </a>
                    </div>
                </div>
                <div id="studentsList" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>
                <div class="text-gray-600">סך הכל: <span id="studentCount">0</span> תלמידים</div>
            </div>

            <!-- Groups Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">יצירת קבוצות</h2>
                
                <!-- AUTO CREATE BUTTON -->
                <div class="bg-green-50 border-2 border-green-400 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-2 text-green-900">🚀 חלוקה אוטומטית חכמה</h3>
                    <button 
                        onclick="autoCreateGroups()" 
                        class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 text-xl font-bold mb-2"
                    >
                        ⚡ צור קבוצות אוטומטית
                    </button>
                    <p class="text-sm text-green-800">
                        המערכת תחלק את כל התלמידים:<br>
                        • קבוצה נומינלית אחת + קבוצות רגילות<br>
                        • חלוקה שווה ככל האפשר<br>
                        • כל קבוצה לפחות 4 חברים
                    </p>
                </div>

                <div class="text-center text-gray-500 mb-4 font-semibold">או צור קבוצות ידנית:</div>
                
                <!-- Manual Group Creation -->
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-3">צור קבוצה חדשה</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block mb-2 font-semibold">סוג קבוצה:</label>
                            <select id="groupType" class="w-full p-2 border-2 rounded-lg">
                                <option value="regular">👥 קבוצה רגילה</option>
                                <option value="nominal">👤 קבוצה נומינלית</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block mb-2 font-semibold">מספר חברים:</label>
                            <input 
                                type="number" 
                                id="groupSize" 
                                min="4" 
                                value="4" 
                                class="w-full p-2 border-2 rounded-lg"
                            />
                        </div>
                        
                        <div class="flex items-end">
                            <button 
                                onclick="createGroup()" 
                                class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold"
                            >
                                ➕ צור קבוצה
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 bg-white p-3 rounded">
                        <strong>💡 טיפ:</strong> תלמידים זמינים: <span id="availableCount" class="font-bold text-green-600">0</span>
                    </div>
                </div>

                <div id="groupsList" class="space-y-3"></div>
            </div>

            <!-- Start Session Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">הפעלת קבוצות</h2>
                
                <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4 mb-4">
                    <div class="font-bold text-purple-900 mb-2">🧪 מצב בדיקה</div>
                    <button onclick="fillDemoAnswers()" class="w-full bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 font-semibold mb-3">
                        מלא תשובות לדוגמה
                    </button>
                    <button onclick="completeAllNow()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 font-semibold">
                        📊 בדוק תשובות והצג תוצאות
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">משך הזמן (דקות):</label>
                    <input type="number" id="durationInput" value="10" min="1" class="w-32 p-3 border rounded-lg"/>
                </div>
                
                <button onclick="startAllGroups()" class="w-full bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 text-lg font-bold">
                    🚀 התחל את כל הקבוצות יחד
                </button>
            </div>
        </div>

        <div id="monitorView" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">ניטור קבוצות פעילות</h2>
                <div id="activeGroupsMonitor" class="space-y-4"></div>
                
                <button onclick="completeAll()" class="w-full mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-bold">
                    📊 סיים והצג תוצאות
                </button>
            </div>
        </div>

        <div id="resultsView" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold mb-6">📊 תוצאות התרגיל</h2>
                
                <div id="summarySection" class="mb-8"></div>
                <div class="mb-8">
                    <canvas id="resultsChart" class="max-w-3xl mx-auto"></canvas>
                </div>
                
                <h3 class="text-2xl font-bold mb-4">תוצאות מפורטות</h3>
                <div id="resultsContainer" class="space-y-6"></div>
                
                <button onclick="resetToSetup()" class="w-full mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
                    התחל תרגיל חדש
                </button>
                
                <button onclick="fullReset()" class="w-full mt-3 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
                    🗑️ איפוס מלא
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const socket = io(API_URL);

        let students = [];
        let groups = [];
        let activeSessions = [];
        let timerIntervals = {};

        socket.on('initialState', (state) => {
            students = state.students || [];
            groups = state.groups || [];
            activeSessions = state.activeSessions || [];
            renderStudents();
            renderGroups();
            updateAvailableCount();
            if (activeSessions.some(s => !s.completed)) {
                showMonitorView();
            }
        });

        socket.on('studentsUpdated', (updatedStudents) => {
            students = updatedStudents;
            renderStudents();
            updateAvailableCount();
        });

        socket.on('groupsUpdated', (updatedGroups) => {
            groups = updatedGroups;
            renderGroups();
            updateAvailableCount();
        });

        socket.on('sessionStarted', (session) => {
            activeSessions.push(session);
            showMonitorView();
            startSessionTimer(session);
        });

        socket.on('sessionEnded', (data) => {
            const session = activeSessions.find(s => s.id === data.sessionId);
            if (session) {
                session.completed = true;
                stopSessionTimer(session.id);
                renderActiveGroups();
            }
        });

        socket.on('allResultsReady', (results) => {
            showResultsView();
            renderResults(results);
        });

        socket.on('systemReset', () => {
            location.reload();
        });

        function updateAvailableCount() {
            const assignedIds = groups.flatMap(g => g.members.map(m => m.id));
            const available = students.filter(s => !assignedIds.includes(s.id));
            const el = document.getElementById('availableCount');
            if (el) el.textContent = available.length;
        }

        async function addDemoStudents() {
            const demoNames = [
                'אבי כהן', 'בני לוי', 'גלי מזרחי', 'דני אברהם',
                'הדר יוסף', 'ונוס הוד', 'זוהר משה', 'חני שרה',
                'טלי יעקב', 'יעל רחל', 'כרמל אהרון', 'לירון מריה',
                'מיכל שמעון', 'נועה לאה', 'סתיו ראובן', 'עדי שמחה',
                'פנינה גד', 'צביה אשר', 'קרן נפתלי', 'רונית דן'
            ];

            if (students.length > 0) {
                if (!confirm('יש כבר תלמידים. להוסיף עוד 20?')) return;
            }

            for (const name of demoNames) {
                try {
                    await fetch(`${API_URL}/api/students/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, skipDuplicateCheck: true })
                    });
                    await new Promise(r => setTimeout(r, 50));
                } catch (e) {
                    console.error(e);
                }
            }
            alert('20 תלמידים נוספו!');
        }

        async function autoCreateGroups() {
            const assignedIds = groups.flatMap(g => g.members.map(m => m.id));
            const availableStudents = students.filter(s => !assignedIds.includes(s.id));
            const total = availableStudents.length;

            if (total < 8) {
                alert('צריך לפחות 8 תלמידים');
                return;
            }

            let numGroups;
            if (total <= 12) numGroups = 2;
            else if (total <= 18) numGroups = 3;
            else if (total <= 24) numGroups = 4;
            else if (total <= 30) numGroups = 5;
            else if (total <= 36) numGroups = 6;
            else numGroups = Math.round(total / 6);

            const baseSize = Math.floor(total / numGroups);
            const remainder = total % numGroups;

            const groupSizes = [];
            for (let i = 0; i < numGroups; i++) {
                groupSizes.push(i < remainder ? baseSize + 1 : baseSize);
            }

            const totalCheck = groupSizes.reduce((a, b) => a + b, 0);
            if (totalCheck !== total) {
                alert(`שגיאה: ${totalCheck} ≠ ${total}`);
                return;
            }

            const sizeCounts = groupSizes.reduce((acc, s) => {
                acc[s] = (acc[s] || 0) + 1;
                return acc;
            }, {});

            let msg = `ליצור ${numGroups} קבוצות?\n\n`;
            msg += `• ${numGroups - 1} רגילות\n• 1 נומינלית\n\n`;
            Object.entries(sizeCounts).sort((a, b) => b[0] - a[0]).forEach(([s, c]) => {
                msg += `• ${c} קבוצות של ${s} חברים\n`;
            });
            msg += `\n✅ סה"כ: ${totalCheck} תלמידים`;

            if (!confirm(msg)) return;

            const originalType = document.getElementById('groupType').value;
            
            for (let i = 0; i < groupSizes.length; i++) {
                const type = i === 0 ? 'nominal' : 'regular';
                document.getElementById('groupType').value = type;
                
                try {
                    await createGroup(groupSizes[i]);
                    await new Promise(r => setTimeout(r, 150));
                } catch (e) {
                    console.error(e);
                }
            }

            document.getElementById('groupType').value = originalType;
            
            const finalAssigned = groups.flatMap(g => g.members.map(m => m.id));
            const finalAvailable = students.filter(s => !finalAssigned.includes(s.id));
            
            if (finalAvailable.length > 0) {
                alert(`⚠️ נשארו ${finalAvailable.length} תלמידים:\n${finalAvailable.map(s => s.name).join(', ')}`);
            } else {
                alert(`✅ ${numGroups} קבוצות נוצרו!\nכל ${total} התלמידים שובצו!`);
            }
        }

        async function createGroup(customSize = null) {
            const type = document.getElementById('groupType').value;
            const size = customSize || parseInt(document.getElementById('groupSize').value);

            if (size < 4) {
                alert('מינימום 4 חברים');
                return;
            }

            const assignedIds = groups.flatMap(g => g.members.map(m => m.id));
            const availableStudents = students.filter(s => !assignedIds.includes(s.id));

            if (availableStudents.length < size) {
                alert(`אין מספיק תלמידים! יש ${availableStudents.length}, צריך ${size}`);
                return;
            }

            const memberIds = availableStudents.slice(0, size).map(s => s.id);
            
            try {
                await fetch(`${API_URL}/api/groups`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, memberIds })
                });
            } catch (e) {
                alert('שגיאה ביצירת קבוצה');
                console.error(e);
            }
        }

        async function deleteGroup(id) {
            if (confirm('למחוק קבוצה זו?')) {
                await fetch(`${API_URL}/api/groups/${id}`, { method: 'DELETE' });
            }
        }

        async function startAllGroups() {
            if (groups.length === 0) {
                alert('אין קבוצות');
                return;
            }
            const duration = parseInt(document.getElementById('durationInput').value) * 60;
            await fetch(`${API_URL}/api/session/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration, groupIds: groups.map(g => g.id) })
            });
        }

        async function fillDemoAnswers() {
            if (groups.length === 0) {
                alert('אין קבוצות!');
                return;
            }
            if (!confirm('למלא תשובות לדוגמה?')) return;

            const demoAnswers = {
                'צנ': ['צבי נשרי', 'ציפי נבון'],
                'תד': ['תמר הוד', 'תום הוד'],
                'קכ': ['קארין כהן', 'קרן כץ'],
                'עג': ['עמוס גילן', 'עדי גינזבורג'],
                'יח': ['יהודה חיון', 'יעל חסון'],
                'לט': ['לירון טבת', 'לאה טל'],
                'מץ': ['משה צור', 'מיכל צפון'],
                'רס': ['רון סער', 'רונית סלע'],
                'סו': ['סיגל ויצמן', 'סמי ועקנין'],
                'טר': ['טל רז', 'טלי רביב']
            };

            for (const group of groups) {
                if (group.type === 'regular') {
                    const answers = {};
                    Object.keys(demoAnswers).forEach(pair => {
                        answers[pair] = demoAnswers[pair].slice(0, Math.random() > 0.5 ? 2 : 1);
                    });
                    try {
                        await fetch(`${API_URL}/api/submissions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                studentId: group.members[0].id,
                                groupId: group.id,
                                answers
                            })
                        });
                    } catch (e) {}
                } else {
                    for (const member of group.members) {
                        const answers = {};
                        Object.keys(demoAnswers).forEach(pair => {
                            answers[pair] = demoAnswers[pair].slice(0, Math.floor(Math.random() * 3));
                        });
                        try {
                            await fetch(`${API_URL}/api/submissions`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    studentId: member.id,
                                    groupId: null,
                                    answers
                                })
                            });
                            await new Promise(r => setTimeout(r, 100));
                        } catch (e) {}
                    }
                }
            }
            alert('תשובות נוספו!');
        }

        async function completeAll() {
            const loading = document.createElement('div');
            loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loading.innerHTML = '<div class="bg-white rounded-xl p-8 text-center"><div class="text-4xl mb-4">⏳</div><div class="text-xl font-bold">בודק שמות...</div></div>';
            document.body.appendChild(loading);

            try {
                await fetch(`${API_URL}/api/sessions/complete-all`, { method: 'POST' });
            } catch (e) {
                loading.remove();
                alert('שגיאה');
            }
        }

        async function completeAllNow() {
            if (!confirm('לבדוק תשובות?')) return;
            await completeAll();
        }

        function startSessionTimer(session) {
            renderActiveGroups();
            timerIntervals[session.id] = setInterval(() => {
                const remaining = Math.max(0, Math.floor((session.endTime - Date.now()) / 1000));
                if (remaining === 0) {
                    stopSessionTimer(session.id);
                    endSession(session.id);
                } else {
                    renderActiveGroups();
                }
            }, 1000);
        }

        function stopSessionTimer(sessionId) {
            if (timerIntervals[sessionId]) {
                clearInterval(timerIntervals[sessionId]);
                delete timerIntervals[sessionId];
            }
        }

        async function endSession(sessionId) {
            await fetch(`${API_URL}/api/session/end/${sessionId}`, { method: 'POST' });
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return m + ':' + s.toString().padStart(2, '0');
        }

        function renderStudents() {
            const el = document.getElementById('studentsList');
            if (!el) return;
            el.innerHTML = students.map(s => `<div class="bg-gray-100 p-3 rounded-lg text-center font-semibold">${s.name}</div>`).join('');
            const countEl = document.getElementById('studentCount');
            if (countEl) countEl.textContent = students.length;
        }

        function renderGroups() {
            const el = document.getElementById('groupsList');
            if (!el) return;
            if (groups.length === 0) {
                el.innerHTML = '<div class="text-gray-500 text-center py-4">אין קבוצות</div>';
                return;
            }
            el.innerHTML = groups.map(g => `
                <div class="border-2 rounded-lg p-4 ${g.type === 'regular' ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                    <div class="flex justify-between mb-2">
                        <div>
                            <h3 class="font-bold text-lg">${g.name}</h3>
                            <span class="text-sm px-3 py-1 rounded-full font-semibold ${g.type === 'regular' ? 'bg-blue-200 text-blue-900' : 'bg-purple-200 text-purple-900'}">
                                ${g.type === 'regular' ? '👥 רגילה' : '👤 נומינלית'} (${g.members.length} חברים)
                            </span>
                        </div>
                        <button onclick="deleteGroup(${g.id})" class="text-red-500 hover:text-red-700 text-xl">🗑️</button>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        ${g.members.map(m => `<span class="bg-white px-3 py-1 rounded-full text-sm font-semibold border-2 ${g.type === 'regular' ? 'border-blue-300' : 'border-purple-300'}">${m.name}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderActiveGroups() {
            const el = document.getElementById('activeGroupsMonitor');
            if (!el) return;
            const active = activeSessions.filter(s => !s.completed);
            if (active.length === 0) {
                el.innerHTML = '<div class="text-gray-500 text-center py-8">אין סשנים פעילים</div>';
                return;
            }
            el.innerHTML = active.map(session => {
                const remaining = Math.max(0, Math.floor((session.endTime - Date.now()) / 1000));
                return `<div class="border-2 border-indigo-300 rounded-lg p-4 bg-indigo-50">
                    <div class="flex justify-between mb-3">
                        <h3 class="text-xl font-bold">סשן ${session.id}</h3>
                        <div class="text-3xl font-bold text-indigo-900">${formatTime(remaining)}</div>
                    </div>
                </div>`;
            }).join('');
        }

        async function renderResults(data) {
            // Simplified results rendering
            document.getElementById('summarySection').innerHTML = '<div class="text-center">תוצאות נטענו</div>';
            document.getElementById('resultsContainer').innerHTML = '<div class="text-center">ראה תוצאות מפורטות</div>';
        }

        function showMonitorView() {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('monitorView').classList.remove('hidden');
            document.getElementById('resultsView').classList.add('hidden');
            renderActiveGroups();
        }

        function showResultsView() {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('monitorView').classList.add('hidden');
            document.getElementById('resultsView').classList.remove('hidden');
            const loading = document.querySelector('.fixed.inset-0');
            if (loading) loading.remove();
        }

        function resetToSetup() {
            if (confirm('למחוק תוצאות?')) {
                document.getElementById('setupView').classList.remove('hidden');
                document.getElementById('monitorView').classList.add('hidden');
                document.getElementById('resultsView').classList.add('hidden');
                activeSessions = [];
                Object.values(timerIntervals).forEach(i => clearInterval(i));
                timerIntervals = {};
            }
        }

        async function fullReset() {
            if (confirm('⚠️ למחוק הכל?')) {
                await fetch(`${API_URL}/api/reset`, { method: 'POST' });
            }
        }
    </script>
</body>
</html>
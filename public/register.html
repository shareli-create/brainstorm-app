<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¨×™×©×•× ×ª×œ××™×“ - ×ª×¨×’×™×œ ×¡×™×¢×•×¨ ××•×—×•×ª</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto p-6 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-2xl p-12 mt-20">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-indigo-900 mb-3">
                    ×‘×¨×•×›×™× ×”×‘××™×!
                </h1>
                <p class="text-xl text-gray-600">
                    ×ª×¨×’×™×œ ×¡×™×¢×•×¨ ××•×—×•×ª - ××¦×™××ª ×©××•×ª ××¤×•×¨×¡××™×
                </p>
            </div>

            <!-- Registration Form -->
            <div id="registrationForm" class="space-y-6">
                <div>
                    <label class="block mb-3 text-lg font-semibold text-gray-800">
                        ×”×–×Ÿ ××ª ×©××š ××• ×›×™× ×•×™:
                    </label>
                    <input
                        type="text"
                        id="nameInput"
                        placeholder="×œ××©×œ: ×™×•×¡×™, ×©×¨×”, ×“× ×™..."
                        class="w-full p-4 text-lg border-2 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        maxlength="50"
                    />
                    <div id="errorMsg" class="hidden mt-2 text-red-600 font-semibold"></div>
                </div>

                <button
                    onclick="register()"
                    id="registerBtn"
                    class="w-full bg-indigo-600 text-white px-6 py-4 rounded-xl hover:bg-indigo-700 text-xl font-bold transition-all transform hover:scale-105"
                >
                    ×”×™×¨×©× ×œ×ª×¨×’×™×œ ğŸš€
                </button>

                <!-- Already Registered Students -->
                <div class="mt-8 pt-8 border-t-2">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        ×ª×œ××™×“×™× ×¨×©×•××™× (<span id="studentCount">0</span>):
                    </h3>
                    <div id="studentsList" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="hidden text-center">
                <div class="text-6xl mb-6">âœ…</div>
                <h2 class="text-3xl font-bold text-green-800 mb-4">
                    × ×¨×©××ª ×‘×”×¦×œ×—×”!
                </h2>
                <p class="text-xl text-gray-700 mb-6">
                    ×©×œ×•×, <span id="registeredName" class="font-bold text-indigo-900"></span>
                </p>
                <p class="text-gray-600 mb-8">
                    ×”××ª×Ÿ ×œ×”× ×—×™×•×ª ×”××¨×¦×”. ×”×ª×¨×’×™×œ ×™×ª×—×™×œ ×‘×§×¨×•×‘.
                </p>
                <a
                    href="student.html"
                    class="inline-block bg-green-600 text-white px-8 py-4 rounded-xl hover:bg-green-700 text-lg font-bold transition-all"
                >
                    ×¢×‘×•×¨ ×œ×××©×§ ×”×ª×¨×’×™×œ â†’
                </a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const socket = io(API_URL);

        let students = [];

        // Socket event listeners
        socket.on('initialState', (state) => {
            students = state.students || [];
            renderStudents();
        });

        socket.on('studentsUpdated', (updatedStudents) => {
            students = updatedStudents;
            renderStudents();
        });

        // Register student
        async function register() {
            const input = document.getElementById('nameInput');
            const name = input.value.trim();
            const errorMsg = document.getElementById('errorMsg');
            const registerBtn = document.getElementById('registerBtn');

            // Validation
            if (!name) {
                errorMsg.textContent = '×× × ×”×–×Ÿ ×©× ××• ×›×™× ×•×™';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (name.length < 2) {
                errorMsg.textContent = '×”×©× ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 2 ×ª×•×•×™×';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Disable button during registration
            registerBtn.disabled = true;
            registerBtn.textContent = '×¨×•×©×...';
            errorMsg.classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/api/students/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    document.getElementById('registrationForm').classList.add('hidden');
                    document.getElementById('successMessage').classList.remove('hidden');
                    document.getElementById('registeredName').textContent = name;
                    
                    // Store student info in localStorage
                    localStorage.setItem('studentId', data.id);
                    localStorage.setItem('studentName', name);
                    
                    // Auto-redirect to student interface after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'student.html';
                    }, 2000);
                } else {
                    errorMsg.textContent = data.error === 'Name already exists' 
                        ? '×”×©× ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª. ×× × ×‘×—×¨ ×©× ××• ×›×™× ×•×™ ××—×¨.'
                        : '×©×’×™××” ×‘×¨×™×©×•×. × ×¡×” ×©×•×‘.';
                    errorMsg.classList.remove('hidden');
                    registerBtn.disabled = false;
                    registerBtn.textContent = '×”×™×¨×©× ×œ×ª×¨×’×™×œ ğŸš€';
                }
            } catch (error) {
                console.error('Registration error:', error);
                errorMsg.textContent = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª. × ×¡×” ×©×•×‘.';
                errorMsg.classList.remove('hidden');
                registerBtn.disabled = false;
                registerBtn.textContent = '×”×™×¨×©× ×œ×ª×¨×’×™×œ ğŸš€';
            }
        }

        // Render registered students
        function renderStudents() {
            const container = document.getElementById('studentsList');
            document.getElementById('studentCount').textContent = students.length;
            
            if (students.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-4">×¢×“×™×™×Ÿ ××™×Ÿ ×ª×œ××™×“×™× ×¨×©×•××™×</div>';
                return;
            }

            container.innerHTML = students.map(s => `
                <div class="bg-indigo-50 px-4 py-2 rounded-lg text-center font-semibold text-indigo-900">
                    ${s.name}
                </div>
            `).join('');
        }

        // Enter key support
        document.getElementById('nameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') register();
        });

        // Auto-focus on input
        document.getElementById('nameInput').focus();
    </script>
</body>
</html>